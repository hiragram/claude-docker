#!/bin/bash
set -euo pipefail

IMAGE_NAME="claude-code-docker"
VOLUME_NAME="claude-code-local"
CLAUDE_HOME="${CLAUDE_HOME:-$HOME/.claude}"
CONTAINER_CLAUDE_HOME="$HOME/.claude-docker"
CONTAINER_CLAUDE_JSON="$HOME/.claude-docker.json"

# --- Dockerが使えるかチェック ---
if ! command -v docker &> /dev/null; then
  echo "Error: docker is not installed or not in PATH." >&2
  exit 1
fi

if ! docker info &> /dev/null; then
  echo "Error: Docker daemon is not running." >&2
  exit 1
fi

# --- Dockerイメージのビルド ---
build_image() {
  echo "Building Docker image '$IMAGE_NAME'..."
  local tmpdir
  tmpdir=$(mktemp -d)
  trap "rm -rf '$tmpdir'" EXIT

  cat > "$tmpdir/entrypoint.sh" << 'ENTRYPOINT_EOF'
#!/bin/bash
set -e

# ホスト側パスへのシンボリックリンクを作成（root権限で実行）
# installed_plugins.json等がホストの絶対パスを参照しているため
if [ -n "$HOST_CLAUDE_HOME" ] && [ "$HOST_CLAUDE_HOME" != "/home/claude/.claude" ]; then
  mkdir -p "$(dirname "$HOST_CLAUDE_HOME")"
  ln -sfn /home/claude/.claude "$HOST_CLAUDE_HOME"
fi

# .local volumeの権限をclaudeユーザーに
chown -R claude:claude /home/claude/.local

# Claude Codeが未インストールならインストール（claudeユーザーで）
if [ ! -x /home/claude/.local/bin/claude ]; then
  echo "Installing Claude Code..."
  su -s /bin/bash claude -c 'curl -fsSL https://claude.ai/install.sh | bash'
fi

# マウントされた.sshの権限を調整（read-onlyマウントなのでコピーして使う）
if [ -d /home/claude/.ssh-host ]; then
  cp -a /home/claude/.ssh-host /home/claude/.ssh
  chown -R claude:claude /home/claude/.ssh
  chmod 700 /home/claude/.ssh
  chmod 600 /home/claude/.ssh/* 2>/dev/null || true
  chmod 644 /home/claude/.ssh/*.pub 2>/dev/null || true
  chmod 644 /home/claude/.ssh/known_hosts 2>/dev/null || true
  chmod 644 /home/claude/.ssh/config 2>/dev/null || true
fi

# マウントされた.config/ghの権限を調整
if [ -d /home/claude/.config/gh ]; then
  chown -R claude:claude /home/claude/.config
fi

# マウントされた.gitconfigの権限を調整
if [ -f /home/claude/.gitconfig ]; then
  chown claude:claude /home/claude/.gitconfig
fi

# workspaceの権限をclaudeユーザーに
if [ -n "${HOST_WORKSPACE:-}" ]; then
  mkdir -p "$HOST_WORKSPACE" 2>/dev/null || true
  chown claude:claude "$HOST_WORKSPACE" 2>/dev/null || true
else
  chown claude:claude /workspace 2>/dev/null || true
fi

# claudeユーザーでコマンドを実行
export HOME=/home/claude
exec setpriv --reuid=$(id -u claude) --regid=$(id -g claude) --init-groups env HOME=/home/claude "$@"
ENTRYPOINT_EOF

  cat > "$tmpdir/Dockerfile" << 'DOCKERFILE_EOF'
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends git curl ca-certificates wget openssh-client && \
    rm -rf /var/lib/apt/lists/*

RUN mkdir -p -m 755 /etc/apt/keyrings && \
    wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg \
      > /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
      > /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends gh && \
    rm -rf /var/lib/apt/lists/*

RUN useradd -m -s /bin/bash claude

ENV PATH="/home/claude/.local/bin:${PATH}"

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
# シンボリックリンク作成先のベースディレクトリをclaude所有にする
RUN mkdir -p /Users && chown claude:claude /Users

WORKDIR /workspace
# Note: WORKDIR is overridden at runtime via --workdir to match host path

ENTRYPOINT ["/entrypoint.sh"]
CMD ["claude"]
DOCKERFILE_EOF

  docker build -t "$IMAGE_NAME" "$tmpdir"
  trap - EXIT
  rm -rf "$tmpdir"
  echo "Docker image '$IMAGE_NAME' built successfully."
}

# --- Dockerイメージのビルド（キャッシュが効くため毎回実行） ---
build_image

# --- Claude Code本体用のvolume作成 ---
docker volume create "$VOLUME_NAME" > /dev/null 2>&1 || true

# --- コンテナ用 ~/.claude-docker/ を準備 ---
mkdir -p "$CONTAINER_CLAUDE_HOME"

# ホストの設定ファイルを同期（毎回最新を反映）
for f in settings.json CLAUDE.md; do
  if [ -f "$CLAUDE_HOME/$f" ]; then
    cp "$CLAUDE_HOME/$f" "$CONTAINER_CLAUDE_HOME/$f"
  fi
done

for d in hooks plugins commands agents; do
  if [ -d "$CLAUDE_HOME/$d" ]; then
    rm -rf "$CONTAINER_CLAUDE_HOME/$d"
    cp -a "$CLAUDE_HOME/$d" "$CONTAINER_CLAUDE_HOME/$d"
  fi
done

# --- ~/.claude.json（オンボーディング状態）がなければ作成 ---
if [ ! -s "$CONTAINER_CLAUDE_JSON" ]; then
  echo '{}' > "$CONTAINER_CLAUDE_JSON"
fi

# --- ホストの git/gh/ssh 設定をマウント ---
HOST_MOUNTS=()
if [ -f "$HOME/.gitconfig" ]; then
  HOST_MOUNTS+=(-v "$HOME/.gitconfig:/home/claude/.gitconfig")
fi
if [ -d "$HOME/.config/gh" ]; then
  HOST_MOUNTS+=(-v "$HOME/.config/gh:/home/claude/.config/gh")
fi
if [ -d "$HOME/.ssh" ]; then
  # entrypoint.sh でコピー＆権限調整するため別パスにマウント
  HOST_MOUNTS+=(-v "$HOME/.ssh:/home/claude/.ssh-host:ro")
fi

# --- git worktree の場合、元リポジトリの .git ディレクトリもマウント ---
# worktree の .git はファイル（ディレクトリではない）で、中身は
#   gitdir: /path/to/original-repo/.git/worktrees/<name>
# コンテナ内からこのパスが見えないと git 操作ができないため、
# 元リポジトリの .git ディレクトリをそのままマウントする
if [ -f "$(pwd)/.git" ]; then
  WORKTREE_GITDIR=$(sed -n 's/^gitdir: //p' "$(pwd)/.git")
  if [ -n "$WORKTREE_GITDIR" ]; then
    # .git/worktrees/<name> → .git を得る（2階層上）
    MAIN_GIT_DIR=$(cd "$WORKTREE_GITDIR/../.." && pwd)
    # ワークスペース配下であれば既にマウントされているので追加不要
    case "$MAIN_GIT_DIR" in
      "$(pwd)"*)
        ;;
      *)
        HOST_MOUNTS+=(-v "$MAIN_GIT_DIR:$MAIN_GIT_DIR")
        ;;
    esac
  fi
fi

# --- Claude起動（未認証ならclaude自身がloginを促す） ---
HOST_WORKSPACE="$(pwd)"
exec docker run -it --rm \
  -e "HOST_CLAUDE_HOME=$CLAUDE_HOME" \
  -e "HOST_WORKSPACE=$HOST_WORKSPACE" \
  -v "$VOLUME_NAME:/home/claude/.local" \
  -v "$CONTAINER_CLAUDE_HOME:/home/claude/.claude" \
  -v "$CONTAINER_CLAUDE_JSON:/home/claude/.claude.json" \
  -v "$HOST_WORKSPACE:$HOST_WORKSPACE" \
  --workdir "$HOST_WORKSPACE" \
  ${HOST_MOUNTS[@]+"${HOST_MOUNTS[@]}"} \
  "$IMAGE_NAME" \
  claude "$@" --allow-dangerously-skip-permissions
